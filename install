#!/bin/sh

set -e

install_nixos() {
    if [ -f /etc/nixos/configuration.nix ] || [ -L /etc/nixos/configuration.nix ]
    then
        echo "Back up existing configuration..."
        sudo mv /etc/nixos/configuration.nix /etc/nixos/configuration.nix.bak
    fi

    sudo ln -s /home/excalibur/nixos-config/flake.nix /etc/nixos/flake.nix
    echo "Install profile completed!"

    RELEASE="23.11"
    sudo nix-channel --add https://mirrors.ustc.edu.cn/nix-channels/nixos-${RELEASE} nixos
    sudo nix-channel --add https://mirrors.ustc.edu.cn/nix-channels/nixos-unstable nixos-unstable
    echo "Update channel completed!"
}

install_nixOnDroid() {
    if [ -f "$HOME/.config/nixpkgs/nix-on-droid.nix" ] || [ -L "$HOME/.config/nixpkgs/nix-on-droid.nix" ]
    then
        echo "Back up existing configuration..."
        mv "$HOME/.config/nixpkgs/nix-on-droid.nix" "$HOME/.config/nixpkgs/nix-on-droid.nix.bak"
    fi
    if [ -d "$HOME/.config/nix-on-droid" ] || [ -d "$HOME/.config/nix-on-droid" ]
    then
        echo "Back up existing configuration..."
        mv "$HOME/.config/nix-on-droid" "$HOME/.config/nix-on-droid.bak"
    fi

    ln -s "$(dirname "$(realpath "$0")")" "$HOME/.config/nix-on-droid"
    echo "Install profile completed!"

    RELEASE="23.11"
    nix-channel --add https://mirrors.ustc.edu.cn/nix-channels/nixos-${RELEASE} nixpkgs
    nix-channel --add https://mirrors.ustc.edu.cn/nix-channels/nixos-unstable nixpkgs-unstable
    echo "Update channel completed!"

    cachix use nix-on-droid
    echo "proot cachix configured!"
}

if [ -d /data/data/com.termux.nix/files/home ]; then
    install_nixOnDroid
else
    install_nixos
fi
